@using PagedList.Mvc
@model PagedList.IPagedList<QLSL.Models.CCTV>
@{
    ViewBag.Title = "CCTV";
    var Page = string.IsNullOrEmpty(Request.Params["page"]) ? null : Request.Params["page"];
    var pageListSize = string.IsNullOrEmpty(Request.Params["pageListSize"]) ? null : Request.Params["pageListSize"];
    int pageNumber = (int)ViewBag.PageNumber;
    int pageSize = (int)ViewBag.PageSize;
    int currentno = ((pageNumber - 1) * pageSize) + 1;
}
    

<div id="MyModal" class="modal fade in">
    <div class="modal-dialog">
        <div class="modal-content">
            <div id="MyModalContent"></div>
        </div>
    </div>
</div>
<h3>Danh sách CCTV</h3>
@using (Html.BeginForm("Index", "CCTV", FormMethod.Get))
{
    if (ViewBag.PageSize != null)
    {
        @Html.Hidden("pageListSize", (int)ViewBag.PageSize)
    }
    <div class="row">
        <div class="col-md-6 col-md-offset-6">
            <div class="input-group">
                <span class="input-group-addon hidden-sm hidden-xs">Filter</span>
                @Html.TextBox("SearchString", ViewBag.CurrentFilter as string, new {@class = "form-control"})
                <span class="input-group-addon hidden-sm hidden-xs" title="hiển thị cả pha cũ">Tất cả</span>
                <span class="input-group-addon default ">
                    @Html.CheckBox("allCCTV", new {@class = "checkbox", title = "All"})
                </span>
                <span class="input-group-btn">
                    <button type="submit" value="Search" class="form-control btn btn-default"><i class="glyphicon glyphicon-search " title="tìm kiếm"></i></button>
                </span>
                @if (ViewContext.HttpContext.User.IsInRole("Admin"))
                {
                    <span class="input-group-btn">
                    @Html.ActionLink(" ", "Create", null, null, new {data_modal = "", id = "btnCreate", @class = "btn btn-primary glyphicon glyphicon-plus", title = "tạo mới", style = "margin-top:-2px"})
                    </span>
                }
            </div>
        </div>
    </div>
}
<br/>
<div class="table-responsive">
    <table class="table table-bordered table-condensed table-hover table-responsive">
        <tr>
            <th>
                STT
            </th>
            <th>
                Tên
            </th>
            <th>
                IP
            </th>
            <th>
                Địa chỉ
            </th>
            <th>
                @Html.ActionLink("NSX", "Index", new {sortOrder = ViewBag.ManSortParm, currentFilter = ViewBag.CurrentFilter, allCCTV = ViewBag.AllCCTV})
            </th>
            <th>
                @Html.ActionLink("Model", "Index", new {sortOrder = ViewBag.ModelSortParm, currentFilter = ViewBag.CurrentFilter, allCCTV = ViewBag.AllCCTV})
            </th>
            <th class="text-center">
                Type
            </th>
            <th class="text-center">
                @Html.ActionLink("Năm", "Index", new {sortOrder = ViewBag.YearInstallSortParm, currentFilter = ViewBag.CurrentFilter, allCCTV = ViewBag.AllCCTV})
            </th>
            <th class="text-center">
                ĐVQL
            </th>
            <th class="text-center">
                ĐB
            </th>
            <th class="text-center">
                Zone
            </th>

            @*<th class="text-center">
                Map
            </th>*@
            <th class="text-center">
                Used
            </th>

            <th></th>
        </tr>
        <tbody id="uBody">
        @foreach (var item in Model)
        {
            <tr>
                <td class="text-center">
                    @currentno
                    @{currentno = currentno + 1;}
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Name)
                </td>

                <td >
                    @Html.DisplayFor(modelItem => item.IP)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Address)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Manufacturer)
                </td>
                <td class="width-12">
                    @Html.DisplayFor(modelItem => item.Model)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.CAMType.Name)
                </td>
                <td class="text-center width-5">
                    @Html.DisplayFor(modelItem => item.YearInstall)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.OwerCCTV.Name)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.LocatyCCTV.Name)
                </td>
                <td>
                    @{
                        foreach (var zone in item.Zones)
                        {
                            @zone.Name
                            <span>&nbsp</span>
                        }
                    }
                </td>
                @*<td class="text-center width-5">
                    @if (item.Map)
                    {
                        <i class="fa fa-check text-primary" aria-hidden="true"></i>
                    }
                </td>*@
                <td class="text-center width-5">
                    @if (!item.Disable)
                    {
                        <i class="fa fa-check text-danger" aria-hidden="true"></i>
                    }
                </td>

                <td class="text-center width-10">
                    @if (ViewContext.HttpContext.User.IsInRole("Admin"))
                    {
                        <a onclick="Edit(@item.CCTVID)" id="btnEdit_@item.CCTVID" class='btn btn-success btn-xs'>
                            <i class='glyphicon glyphicon-pencil'></i>
                        </a>
                        <button onclick="Delete(@item.CCTVID, this)" class='btn btn-danger btn-xs' @(ViewContext.HttpContext.User.IsInRole("Admin") ? "" : "disabled")>
                            <i class='glyphicon glyphicon-remove'></i>
                        </button>
                    }
                    <a onclick="EditMain(@item.CCTVID)" id="btnEditMain_@item.CCTVID" class='btn btn-default btn-xs'>
                        <i class='glyphicon glyphicon-edit'></i>
                    </a>
                </td>
            </tr>
        }
        </tbody>
    </table>
</div>
<div class="form-horizontal text-right">
    <div class="pager" style="margin-top: 0px">
        <div class="pull-left">
            @using (Html.BeginForm("Index", "CCTV", FormMethod.Get))
            {
                if (!string.IsNullOrEmpty(ViewBag.CurrentSort))
                {
                    @Html.Hidden("sortOrder", (string)ViewBag.CurrentSort)
                }

                if (!string.IsNullOrEmpty(ViewBag.CurrentFilter))
                {
                    @Html.Hidden("currentFilter", (string)ViewBag.CurrentFilter)
                }

                if (ViewBag.AllCCTV != null)
                {
                    @Html.Hidden("allCCTV", (bool)ViewBag.AllCCTV)
                }

                <p>

                    @Html.DropDownList("pageListSize", new SelectList(new Dictionary<string, int> { { "20", 20 }, { "50", 50 }, { "100", 100 } }, "Key", "Value"), new { @class = "form-control", id = "pagesizelist" })
                </p>
            }
        </div>
        <div class="pull-right">
            @Html.PagedListPager(Model, page => Url.Action("Index", new { page, sortOrder = ViewBag.CurrentSort, currentFilter = ViewBag.CurrentFilter, pageListSize = ViewBag.PageSize, allCCTV = ViewBag.AllCCTV }))
            Page @(Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber) of @Model.PageCount (@Model.TotalItemCount record)
        </div>
    </div>
</div>

@section Scripts {

    @Scripts.Render("~/bundles/modalFormjs")
    <script>
        $("#pagesizelist").change(function (event) {
            var form = $(event.target).parents("form");
            form.submit();

        });
        var Edit = function(ID) {
            $.ajaxSetup({ cache: false });
            var EditUrl = "/CCTV/Edit/" + ID;
            $("#MyModalContent")
                .load(EditUrl,
                    function() {
                        $("#MyModal")
                            .modal({
                                    backdrop: 'static',
                                    keyboard: false
                                },
                                'show');
                        bindForm(this);
                    });
            return false;
        };
        var EditMain = function (ID) {
            $.ajaxSetup({ cache: false });
            var EditUrl = "/CCTV/EditMain/" + ID;
            $("#MyModalContent")
                .load(EditUrl,
                    function () {
                        $("#MyModal")
                            .modal({
                                backdrop: 'static',
                                keyboard: false
                            },
                                'show');
                        bindForm(this);
                    });
            return false;
        };
        var Delete = function(ID, element) {
            var Msg = "";
            $.ajax({
                url: "/CCTV/GetDetails",
                type: "GET",
                data: { ID: ID },
                success: function(result) {
                    Msg = "Tên : <b>" + result.Name + "</b>";
                    Msg += "<br/>IP : " + result.IP;
                    Msg += "<br/>Address : " + result.Address;

                    bootbox.confirm({
                        title: "Xóa nhật ký",
                        message: Msg,
                        buttons: {
                            confirm: {
                                label: 'Yes',
                                className: 'btn-success'
                            },
                            cancel: {
                                label: 'No',
                                className: 'btn-danger'
                            }
                        },
                        callback: function(result) {
                            if (result) {
                                deleteConfirmed(ID, element);
                            }
                        }
                    });

                },
                error: function(error) {
                    console.log(error);
                    alert(error);
                }
            });
        };
        var deleteConfirmed = function(ID, element) {
            $.ajax({
                url: "/CCTV/DeleteConfirmed",
                type: "GET",
                data: { ID: ID },
                success: function(result) {
                    if (result === "Success") {
                        toastr.success(result + ' Deleted.');
                        $(element).closest("tr").toggle();
                    }

                },
                error: function(error) {
                    console.log(error);
                    alert(error);
                }
            });
        };
        var tableDraw = function() {
            $.ajax({
                url: "/CCTV/UpdateTable",
                type: "GET",
                data: { page: "@Page", pageListSize: "@pageListSize" },
                success: function(result) {
                    $('#uBody').replaceWith(result);
                },
                error: function(error) {
                    console.log(error);
                    alert(error);
                }
            });
        };
    </script>
}